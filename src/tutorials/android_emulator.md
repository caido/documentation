# Proxying Android Emulator Traffic

In this tutorial, we will cover the process of configuring an **Android Virtual Device (AVD)**, to proxy its traffic through Caido.

::: info

You will need to [download and install Android Studio](https://developer.android.com/studio) for your operating system and [create an AVD](https://developer.android.com/studio/run/managing-avds?utm_source=android-studio) using a system image that does not include Google Play.
:::

## Android Studio

Android Studio is the official IDE for developing Android applications. It features the Android Emulator that can create a variety of AVDs at specified API levels.

[Download and install Android Studio for your operating system.](https://developer.android.com/studio)

The installation also includes the Android SDK which provides multiple packages of command-line tools, including:

- `adb`: The **Android Debug Bridge**, included in the Platform-Tools package, allows you to interface with the Android device using your computer's terminal.
- `emulator`: Included in Emulator package, this terminal command allows you to start an AVD.

You can view the location of the available SDK developer tools by selecting `SDK Manager` from the `More Actions` dropdown menu of the `Projects` interface.

<img alt="List of connected Android devices." src="/_images/sdk_manager.png" center no-shadow/>

In the window that appears, the `Android SDK Location` will contain the full file path to the packages.

<img alt="List of connected Android devices." src="/_images/android_studio_sdk_tools.png" center no-shadow/>

Make both `adb` and `emulator` globally accessible by adding their directories to your system's PATH environment variable.

## System Images and Certificate Stores

Android manages both user-installed and system SSL/TLS certificates. However, some applications may not trust user-installed certificates and instead refer to the pre-installed system level certificates, located in the `/system/etc/security/cacerts` directory, that are trusted by the Android system.

To capture HTTPS traffic from these applications, we must inject the Caido CA certificate into the system store, which requires root access as the `/system` partition is mounted as read-only by default.

::: warning NOTE
System images that include Google Play in their build are signed with a release key and don't allow root access, making certificate injection impossible. In order to capture HTTPS traffic generated by an application with Caido, avoid selecting any Google Play builds when [creating an AVD](https://developer.android.com/studio/run/managing-avds?utm_source=android-studio).

Instead, use images listed as:

- Google APIs
- Android Open Source Project (AOSP)
- Default Android System Image
- Base versions (_Android x.x.x ()_)
:::

## Renaming Caido's CA Certificate

In order for Caido's CA Certificate to be compatible with the Android system, it will need to meet the naming conventions of the system store.

1. Generate the legacy hash of Caido's CA certificate's subject field:

```
openssl x509 -inform DER -subject_hash_old -in </path/to/your/cacert.der>
```

2. Rename the Caido CA certificate to the hash with a `.0` extension.

## Configuring the Android Device

1. List your available AVDs:

```
emulator -list-avds
```

<img alt="List of connected Android devices." src="/_images/avd_name.png" center no-shadow/>

2. Launch the desired AVD:

```
emulator -avd <avd> -writable-system
```

3. In a new terminal, restart the `adbd` process on the emulator to gain root privileges:

```
adb root
```

<img alt="List of connected Android devices." src="/_images/restart_adbd.png" center no-shadow/>

4. Disable secure boot verification:

```
adb shell avbctl disable-verification
```

<img alt="List of connected Android devices." src="/_images/adb_disable_verification.png" center no-shadow/>

5. Reboot the device:

```
adb reboot
```

6. Restart the device with root permissions:

```
adb root
```

7. Remount the partitions as read-write:

```
adb remount
```

8. Push the renamed Caido certificate to the system store:

```
adb push </path/to/certificate> /system/etc/security/cacerts
```

9. Set the proper permissions:

```
adb shell chmod 664 -v /system/etc/security/cacerts/<certificate>
```

10. Reboot the device:

```
adb reboot
```
